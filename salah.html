<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Noor Al Huda â€” Salah</title>
<style>
  /* --- KEEP HEADER STYLES AS YOU SENT --- */
  body { margin:0; font-family:Arial,sans-serif; background:#f4f6f8; color:#222; transition:background 0.3s,color 0.3s; }
  header { background:#2e7d32; color:#fff; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
  header .brand { display:flex; align-items:center; gap:10px; }
  header .brand img { height:40px; }
  header h1 { margin:0; font-size:1.2rem; }
  header .arabic { font-family:"Amiri",serif; }
  #mainNav { display:flex; gap:0.5rem; }
  #mainNav a, #mainNav button {
    background:#fff; color:#0b7d40; padding:0.4rem 0.9rem; border-radius:20px; font-weight:600;
    text-decoration:none; border:none; cursor:pointer; transition:background 0.2s,color 0.2s;
  }
  #mainNav a:hover, #mainNav button:hover { background:#065c2f; color:#fff; }
  .hamburger { display:none; font-size:1.5rem; background:none; border:none; color:#fff; cursor:pointer; }
  @media(max-width:768px){
    #mainNav{display:none;flex-direction:column;background:#0b7d40;position:absolute;top:60px;right:0;padding:1rem;}
    #mainNav.open{display:flex;}
    .hamburger{display:block;}
  }

  .container { max-width:900px; margin:20px auto; background:#fff; border:1px solid #d8dee4; border-radius:8px; padding:20px; }
  .controls { display:flex; gap:10px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
  .controls select { padding:6px 10px; border-radius:6px; border:1px solid #cfd7e3; }
  .card { border:1px solid #d8dee4; border-radius:8px; padding:12px; background:#fff; }
  .card h3 { margin:0 0 8px; font-size:1rem; color:#0b7d40; }
  .row { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #e5e7eb; }
  .row:last-child { border-bottom:none; }
  .links { margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
  .links a { text-decoration:none; color:#0b7d40; background:#fff; padding:.4rem .8rem; border-radius:8px; border:1px solid #c8e6c9; font-weight:600; }
  .links a:hover { background:#065c2f; color:#fff; }
  .adhan-toggle { margin-left:auto; display:flex; align-items:center; gap:6px; }

  /* Dark mode */
  body.dark-mode { background:#0f1216; color:#e7ebf0; }
  body.dark-mode header { background:#1f6a28; }
  body.dark-mode #mainNav a, body.dark-mode #mainNav button { background:#1e2430; color:#e7ebf0; }
  body.dark-mode #mainNav a:hover, body.dark-mode #mainNav button:hover { background:#4fb477; color:#fff; }
  body.dark-mode .container { background:#161a20; border-color:#2a3140; }
  body.dark-mode .card { background:#121621; border-color:#2a3140; }
  body.dark-mode .card h3 { color:#4fb477; }
</style>
</head>
<body>

<!-- ==== HEADER: left unchanged ==== -->
<header>
  <div class="brand">
    <img src="logo.png.png" alt="Noor Al Huda Logo">
    <h1>Noor Al Huda <span class="arabic">Ù†ÙˆØ± Ø§Ù„Ù‡Ø¯Ù‰</span></h1>
  </div>
  <button class="hamburger" onclick="toggleMenu()">â˜°</button>
  <nav id="mainNav">
    <a href="quran.html">ğŸ“– Qurâ€™an</a>
    <a href="duas.html">ğŸ¤² Duas</a>
    <a href="hadiths-home.html">ğŸ“œ Hadiths</a>
    <a href="calendar.html">ğŸ“… Calendar</a>
    <a href="salah.html" class="active">ğŸ•Œ Salah</a>
    <a href="index.html" class="utility">ğŸ </a>
    <a href="settings.html" class="utility">âš™</a>
    <button class="btn utility" id="themeToggle" onclick="toggleDarkMode()">ğŸŒ™</button>
  </nav>
</header>

<!-- ==== MAIN CONTENT ==== -->
<div class="container" id="content" style="font-size:16px">
  <div class="controls">
    <label>
      <strong>City:</strong>
      <select id="citySelect">
        <!-- extended list of cities (value is key used below) -->
        <option value="London">London, UK</option>
        <option value="Bedford">Bedford, UK</option>
        <option value="Islamabad">Islamabad, Pakistan</option>
        <option value="Tehran">Tehran, Iran</option>
        <option value="Karbala">Karbala, Iraq</option>
        <option value="Najaf">Najaf, Iraq</option>
        <option value="Qom">Qom, Iran</option>
        <option value="Mashhad">Mashhad, Iran</option>
        <option value="Beirut">Beirut, Lebanon</option>
        <option value="Dearborn">Dearborn, USA</option>
        <option value="Mumbai">Mumbai, India</option>
        <option value="Toronto">Toronto, Canada</option>
        <option value="NewYork">New York, USA</option>
        <option value="LosAngeles">Los Angeles, USA</option>
        <option value="Sydney">Sydney, Australia</option>
        <option value="Cairo">Cairo, Egypt</option>
        <option value="Riyadh">Riyadh, Saudi Arabia</option>
      </select>
    </label>

    <label class="adhan-toggle">
      <input type="checkbox" id="adhanToggle"/> Adhan On
    </label>

    <span id="tzLabel" style="margin-left:10px;"></span>
    <span id="dateLabel" style="margin-left:8px;"></span>
  </div>

  <div class="card">
    <h3 id="cityTitle">Salah times</h3>
    <div class="row"><span>Fajr</span><span id="fajr">â€”</span></div>
    <div class="row"><span>Sunrise</span><span id="sunrise">â€”</span></div>
    <div class="row"><span>Dhuhr</span><span id="dhuhr">â€”</span></div>
    <div class="row"><span>Asr</span><span id="asr">â€”</span></div>
    <div class="row"><span>Maghrib</span><span id="maghrib">â€”</span></div>
    <div class="row"><span>Isha</span><span id="isha">â€”</span></div>
  </div>

  <!-- Links placed below the card (outside header) as requested -->
  <div class="links">
    <a href="qibla.html">ğŸ§­ Qibla Direction</a>
    <a href="https://salahduas.org" target="_blank" rel="noopener">ğŸŒ Salah Duas</a>
  </div>

  <p id="status" style="color:#666; margin-top:12px;"></p>
</div>

<!-- Adhan audio (online Shia adhan source). Replace URL if you prefer another recording. -->
<audio id="adhanAudio" preload="auto" src="https://www.shiasource.com/wp-content/uploads/2018/07/adhan_alhalawaji.mp3"></audio>

<script>
/* --- keep header interactions and theme behaviour like before --- */
function toggleMenu(){document.getElementById("mainNav").classList.toggle("open");}
function toggleDarkMode(){
  document.body.classList.toggle("dark-mode");
  localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
}
(function restoreTheme(){ if(localStorage.getItem("theme")==="dark"){document.body.classList.add("dark-mode");} })();

/* ===== City -> country mapping for AlAdhan API (timingsByCity) ===== */
const CITY_COUNTRY = {
  London:    {city:"London", country:"United Kingdom"},
  Bedford:   {city:"Bedford", country:"United Kingdom"},
  Islamabad: {city:"Islamabad", country:"Pakistan"},
  Tehran:    {city:"Tehran", country:"Iran"},
  Karbala:   {city:"Karbala", country:"Iraq"},
  Najaf:     {city:"Najaf", country:"Iraq"},
  Qom:       {city:"Qom", country:"Iran"},
  Mashhad:   {city:"Mashhad", country:"Iran"},
  Beirut:    {city:"Beirut", country:"Lebanon"},
  Dearborn:  {city:"Dearborn", country:"United States"},
  Mumbai:    {city:"Mumbai", country:"India"},
  Toronto:   {city:"Toronto", country:"Canada"},
  NewYork:   {city:"New York", country:"United States"},
  LosAngeles:{city:"Los Angeles", country:"United States"},
  Sydney:    {city:"Sydney", country:"Australia"},
  Cairo:     {city:"Cairo", country:"Egypt"},
  Riyadh:    {city:"Riyadh", country:"Saudi Arabia"}
};

/* AlAdhan API base */
const ALADHAN_BASE = "https://api.aladhan.com/v1/timingsByCity";

/* Jafari method: method=0 (AlAdhan uses 0 for Jafari / Shia Ithna-Ashari) */
/* We'll ask the API for today's timings for the chosen city and country with method=0 */
const API_METHOD = 0;

/* Add a 3-minute delay (user requested) */
const DELAY_MINUTES = 3;

/* Track last adhan played for each prayer for today to avoid repeat */
let lastPlayed = { date: null, fajr: false, dhuhr: false, asr: false, maghrib: false, isha: false };

/* Utility: pad */
function pad(n){ return String(n).padStart(2,"0"); }

/* Convert API time "HH:MM" (24h) to Date object for today's local timezone */
function timeStrToDateLocal(timeStr){
  // timeStr expected like "05:12"
  const [hh,mm] = timeStr.split(":").map(s=>parseInt(s,10));
  const d = new Date();
  d.setHours(hh, mm, 0, 0);
  return d;
}

/* Add minutes to a Date (in-place) */
function addMinutes(date, mins){
  return new Date(date.getTime() + mins*60000);
}

/* Format date to HH:MM string */
function formatHM(d){
  return pad(d.getHours()) + ":" + pad(d.getMinutes());
}

/* Update UI with timings (delayed by DELAY_MINUTES) */
function updateUI(timings){
  const prayerIds = ["Fajr","Sunrise","Dhuhr","Asr","Maghrib","Isha"];
  // map keys from API (some APIs use lowercase keys). AlAdhan returns e.g. timings.Fajr
  const map = { Fajr:"fajr", Sunrise:"sunrise", Dhuhr:"dhuhr", Asr:"asr", Maghrib:"maghrib", Isha:"isha" };
  prayerIds.forEach(key => {
    const id = map[key];
    const apiTime = timings[key]; // "HH:MM"
    if(!apiTime){ document.getElementById(id).textContent = "â€”"; return; }
    // convert to local Date, add delay minutes, format
    const dtLocal = addMinutes(timeStrToDateLocal(apiTime), DELAY_MINUTES);
    document.getElementById(id).textContent = formatHM(dtLocal);
  });
}

/* Call AlAdhan API for selected city & update page */
async function fetchAndRenderForCity(key){
  const info = CITY_COUNTRY[key];
  const status = document.getElementById("status");
  status.textContent = "Fetching prayer times for " + info.city + ", " + info.country + " ...";
  try {
    const url = `${ALADHAN_BASE}?city=${encodeURIComponent(info.city)}&country=${encodeURIComponent(info.country)}&method=${API_METHOD}`;
    const resp = await fetch(url);
    if(!resp.ok) throw new Error("API error: " + resp.status);
    const json = await resp.json();
    if(json.code !== 200 || !json.data || !json.data.timings) throw new Error("Invalid API response");
    // update UI
    updateUI(json.data.timings);
    // update meta info
    document.getElementById("cityTitle").textContent = "Salah times â€” " + info.city + ", " + info.country + " (JaÊ¿farÄ«)";
    // timezone and date (api returns meta.timezone)
    const tz = json.data.meta && json.data.meta.timezone ? json.data.meta.timezone : Intl.DateTimeFormat().resolvedOptions().timeZone;
    document.getElementById("tzLabel").textContent = tz;
    document.getElementById("dateLabel").textContent = new Date().toLocaleDateString();
    status.textContent = "";
    // reset lastPlayed if date changed
    const todayStr = new Date().toDateString();
    if(lastPlayed.date !== todayStr){
      lastPlayed = { date: todayStr, fajr:false, dhuhr:false, asr:false, maghrib:false, isha:false };
    }
  } catch (err){
    console.error(err);
    status.textContent = "Could not load API timings â€” falling back to local calculation (may be less precise).";
    // fallback: simple rough times (best-effort) using previous local solar algorithm could be implemented here.
    // For now show dashes
    ["fajr","sunrise","dhuhr","asr","maghrib","isha"].forEach(id => document.getElementById(id).textContent = "â€”");
  }
}

/* Play Adhan when current time matches any prayer (delayed times) */
function checkAndPlayAdhan(){
  if(!document.getElementById("adhanToggle").checked) return;
  const now = new Date();
  const hhmm = formatHM(now);
  // Only check minute precision; match against displayed times
  const prayers = { fajr: "fajr", dhuhr: "dhuhr", asr: "asr", maghrib: "maghrib", isha: "isha" };
  const audio = document.getElementById("adhanAudio");
  for(const key in prayers){
    const el = document.getElementById(prayers[key]);
    if(!el) continue;
    const t = el.textContent;
    if(t === hhmm && !lastPlayed[key]){
      // attempt to play (browsers may require a user gesture to allow sound â€” user should click Adhan On or interact with page)
      audio.currentTime = 0;
      const playPromise = audio.play();
      if(playPromise !== undefined){
        playPromise.catch(e => {
          // autoplay blocked â€” inform user
          console.warn("Autoplay blocked:", e);
          document.getElementById("status").textContent = "Adhan blocked by browser; tap anywhere to allow sound.";
        });
      }
      lastPlayed[key] = true;
    }
  }
}

/* Attach events and auto-refresh */
document.getElementById("citySelect").addEventListener("change", e => {
  fetchAndRenderForCity(e.target.value);
});

/* Initial load: use selection or fallback */
(function init(){
  // choose default from local storage or present selection
  const savedCity = localStorage.getItem("salah_city");
  if(savedCity && CITY_COUNTRY[savedCity]) document.getElementById("citySelect").value = savedCity;
  const sel = document.getElementById("citySelect").value;
  fetchAndRenderForCity(sel);

  // save selection
  document.getElementById("citySelect").addEventListener("change", (e)=>{
    localStorage.setItem("salah_city", e.target.value);
  });

  // update every 30 seconds to be responsive and check adhan
  setInterval(async () => {
    // refresh times every 10 minutes to avoid overusing API, but keep UI checks frequent
    const now = new Date();
    const minutes = now.getMinutes();
    // refresh times at minute 0, 10, 20, 30, 40, 50
    if(minutes % 10 === 0){
      const currentCity = document.getElementById("citySelect").value;
      await fetchAndRenderForCity(currentCity);
    }
    checkAndPlayAdhan();
  }, 30*1000);

  // also run check each minute on the minute to match HH:MM exactly
  setInterval(checkAndPlayAdhan, 60*1000);

  // friendly notice about sound
  document.addEventListener("click", ()=> {
    // clicking the page may allow audio autoplay afterwards in some browsers
    if(document.getElementById("status").textContent.includes("blocked")){
      document.getElementById("status").textContent = "";
    }
  });
})();
</script>
</body>
</html>
