<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Al-Kafi — Volume 1, Chapter 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Fonts: Inter (English) + Amiri (Arabic Naskh) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Amiri&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Muted, modern palette */
      --bg: #f5f6f7;
      --card-bg: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #0f766e;        /* soft teal accent */
      --border: #e6e7ea;
      --isnad: #305a99;         /* calm blue for isnad */
      --link: #285f74;          /* muted link color */
      --shadow: 0 2px 8px rgba(17,24,39,0.06);
      --subcard-bg: #f8f9fb;    /* subtle subchapter card bg */
    }

    /* Base */
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header (keep your site structure; muted styling) */
    header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
    }
    .header-inner {
      max-width: 1000px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand h1 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.2px;
    }
    .brand .arabic {
      font-family: Amiri, serif;
      font-weight: 400;
      color: var(--accent);
      margin-left: 6px;
      font-size: 1.2rem;
    }
    nav a {
      color: var(--link);
      text-decoration: none;
      font-weight: 600;
    }
    nav a:hover { text-decoration: underline; }

    /* Layout */
    main {
      max-width: 900px;
      margin: 28px auto;
      padding: 0 20px 40px;
    }
    h2.title {
      text-align: center;
      color: #374151;
      font-weight: 700;
      margin: 12px 0 8px;
      letter-spacing: 0.2px;
    }
    .meta {
      text-align: center;
      color: var(--muted);
      font-size: 0.95rem;
      margin-bottom: 16px;
    }

    /* Cards */
    .hadith-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .hadith-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 18px;
      margin: 14px 0;
      box-shadow: var(--shadow);
    }
    .hadith-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }
    .hadith-number {
      font-weight: 700;
      color: var(--accent);
      font-size: 0.98rem;
    }
    .source-link a {
      color: var(--link);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .source-link a:hover { text-decoration: underline; }

    /* Isnād: distinct but calm color */
    .isnad {
      color: var(--isnad);
      font-size: 0.96rem;
      line-height: 1.7;
      margin: 6px 0;
    }

    /* Arabic: Thaqalayn-like readability */
    .text-ar {
      font-family: Amiri, serif;
      direction: rtl;
      text-align: justify;
      font-size: 1.2rem;
      line-height: 2.0;
      word-spacing: 1px;
      letter-spacing: 0.1px;
      margin-top: 6px;
      color: #111827;
    }

    /* English: clear, modern */
    .text-en {
      margin-top: 10px;
      color: #212b36;
      font-size: 1rem;
      line-height: 1.75;
    }

    /* Gradings (muted, unobtrusive) */
    .gradings {
      margin-top: 10px;
      color: var(--muted);
      font-size: 0.92rem;
    }
    .grading-pill {
      display: inline-block;
      background: #f2f5ff;
      color: #3949ab;
      border: 1px solid #e3e7ff;
      border-radius: 999px;
      padding: 3px 10px;
      margin-right: 6px;
      margin-top: 6px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    /* Subchapter heading card */
    .subchapter-card {
      background: var(--subcard-bg);
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      margin: 18px 0 8px;
    }
    .subchapter-title {
      font-weight: 700;
      color: #374151;
    }
    .subchapter-meta {
      color: var(--muted);
      font-size: 0.9rem;
    }

    footer {
      border-top: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--muted);
      font-size: 0.9rem;
      text-align: center;
      padding: 16px 20px;
    }

    /* Status */
    .status {
      text-align: center;
      color: var(--muted);
      padding: 14px 0;
    }

    /* Small screens */
    @media (max-width: 560px) {
      .hadith-card { padding: 14px 14px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <img src="logo.png.png" alt="Noor Al Huda Logo" width="50" height="36" style="border-radius:6px;">
        <h1>Al-Kafi <span class="arabic">الكافي</span></h1>
      </div>
      <nav>
        <a href="alkafi.html">← Back to Al-Kafi</a>
      </nav>
    </div>
  </header>

  <main>
    <h2 class="title">Volume 1 — Chapter 2: The Book on Virtue of Knowledge</h2>
    <div class="meta">Author: Shaykh Muḥammad b. Yaʿqūb al-Kulaynī • Translation: Muhammad Sarwar</div>

    <ul id="hadithContainer" class="hadith-list">
      <li class="status">Loading hadiths…</li>
    </ul>
  </main>

  <footer>
    © 2025 Noor Al Huda — Personal Islamic Companion (Shia Ithna Ashari)
  </footer>

  <script>
    // Extract hadith number from leading "1." in englishText/arabicText; fallback to index + 1
    function extractHadithNumber(entry, fallbackIndex) {
      const en = (entry.englishText || "").trim();
      const ar = (entry.arabicText || "").trim();
      const numMatchEn = en.match(/^(\d+)\s*\./);
      const numMatchAr = ar.match(/^(\d+)\s*[\.\u066B]/);
      if (numMatchEn) return Number(numMatchEn[1]);
      if (numMatchAr) return Number(numMatchAr[1]);
      return fallbackIndex + 1;
    }

    // Isnād from provided fields or heuristic
    function getIsnad(entry) {
      if (entry.thaqalaynSanad && entry.thaqalaynSanad.trim()) return entry.thaqalaynSanad.trim();
      const en = (entry.englishText || "");
      const q = en.indexOf("“");
      if (q > 0) return en.slice(0, q).trim();
      return "";
    }

    // Matn (English) from provided field or quotes
    function getMatn(entry) {
      if (entry.thaqalaynMatn && entry.thaqalaynMatn.trim()) return entry.thaqalaynMatn.trim();
      const en = (entry.englishText || "");
      const qStart = en.indexOf("“");
      const qEnd = en.lastIndexOf("”");
      if (qStart >= 0 && qEnd > qStart) return en.slice(qStart, qEnd + 1).trim();
      return en.trim();
    }

    // Robust Chapter 2 matcher: exact name or partial matches (English/Arabic)
    function isChapter2(entry) {
      const chap = (entry.chapter || "").trim();
      const cat = (entry.category || "").trim();

      const exactNames = [
        "The Book on Virtue of Knowledge",
        "The Book of Virtue of Knowledge"
      ];
      const partials = [
        "Virtue of Knowledge",
        "Merits of Knowledge",
        "فضل العلم"
      ];

      if (exactNames.includes(chap) || exactNames.includes(cat)) return true;
      return partials.some(p => chap.includes(p) || cat.includes(p));
    }

    // Render with subchapter headings
    async function loadHadiths() {
      const url = "https://raw.githubusercontent.com/MohammedArab1/ThaqalaynAPI/refs/heads/main/V2/ThaqalaynData/1.json";
      const container = document.getElementById("hadithContainer");

      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Filter to Chapter 2 (robust)
        const entries = data.filter(isChapter2);

        container.innerHTML = "";

        if (!entries.length) {
          container.innerHTML = '<li class="status">No hadiths found for Chapter 2.</li>';
          return;
        }

        // Sort by subchapter then by id for clean ordering
        entries.sort((a, b) => {
          const sa = Number(a.chapterInCategoryId ?? 0);
          const sb = Number(b.chapterInCategoryId ?? 0);
          if (sa !== sb) return sa - sb;
          return Number(a.id ?? 0) - Number(b.id ?? 0);
        });

        let currentSub = null;

        entries.forEach((h, idx) => {
          const subIdRaw = h.chapterInCategoryId;
          const subIndex = Number.isFinite(Number(subIdRaw)) ? Number(subIdRaw) : null;

          // Insert a subchapter heading when subchapter changes
          if (subIndex !== null && subIndex !== currentSub) {
            currentSub = subIndex;
            const heading = document.createElement("li");
            heading.className = "subchapter-card";
            heading.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div class="subchapter-title">Subchapter ${subIndex + 1}</div>
                <div class="subchapter-meta">${h.category || h.chapter || ""}</div>
              </div>
            `;
            container.appendChild(heading);
          }

          // Hadith card
          const number = extractHadithNumber(h, idx);
          const isnad = getIsnad(h);
          const matnEn = getMatn(h);

          const li = document.createElement("li");
          li.className = "hadith-card";

          li.innerHTML = `
            <div class="hadith-header">
              <div class="hadith-number">Hadith ${number}</div>
              <div class="source-link">${h.URL ? `<a href="${h.URL}" target="_blank" rel="noopener">Source ↗</a>` : ""}</div>
            </div>

            ${isnad ? `<div class="isnad">${isnad}</div>` : ""}

            ${h.arabicText ? `<div class="text-ar">${h.arabicText}</div>` : ""}

            <div class="text-en">${matnEn}</div>

            ${Array.isArray(h.gradingsFull) && h.gradingsFull.length ? `
              <div class="gradings">
                ${h.gradingsFull.map(g => {
                  const grade = (g.grade_ar || g.grade_en || "").trim();
                  const author = g.author && (g.author.name_en || "").trim();
                  const ref = (g.reference_en || "").trim();
                  const label = [grade, author].filter(Boolean).join(" — ");
                  return `<span class="grading-pill" title="${ref}">${label}</span>`;
                }).join(" ")}
              </div>
            ` : ""}
          `;

          container.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        container.innerHTML = '<li class="status">Error loading hadiths. Please try again later.</li>';
      }
    }

    loadHadiths();
  </script>
</body>
</html>
